<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Countryballs.io</title>
    <style>
        body { margin: 0; background: white; overflow: hidden; }
        canvas { display: block; }
        #leaderboard { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: rgba(0, 0, 0, 0.7); 
            color: white; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: Arial, sans-serif;
        }
        #serverSelect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-family: Arial, sans-serif;
        }
        #serverSelect button {
            background-color: #444;
            color: white;
            border: none;
            padding: 10px;
            margin: 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        #serverSelect button:hover {
            background-color: #666;
        }
    </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="leaderboard">Leaderboard</div>
<div id="serverSelect">
    <h3>Selecciona un servidor</h3>
    <div id="serverList"></div>
    <button id="createServerBtn">Crear un nuevo servidor</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAZM_UTKUtkjoXSmhAU2yFaWTgt9oUwktA",
    authDomain: "virtualblocks-servers.firebaseapp.com",
    databaseURL: "https://virtualblocks-servers-default-rtdb.firebaseio.com",
    projectId: "virtualblocks-servers",
    storageBucket: "virtualblocks-servers.appspot.com",
    messagingSenderId: "796633829717",
    appId: "1:796633829717:web:fcbd2d376565b0160e1fdc"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const images = ["polandball.png", "usa.png", "germany.png", "france.png"];
let player = { id: null, x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 30, image: "", name: "", score: 0 };
let players = {};
let points = [];
let targetX = player.x;
let targetY = player.y;
let hasLost = false;
let serverId = null; // Guardará el id del servidor seleccionado

auth.onAuthStateChanged(user => {
    if (user) {
        player.id = user.uid;
        player.name = user.displayName || "Anónimo";
        player.image = images[Math.floor(Math.random() * images.length)];

        // Mostrar la pantalla de selección de servidor
        showServerSelectScreen();

        db.ref("servers").on("value", snapshot => {
            let servers = snapshot.val() || {};
            displayServers(servers);
        });

        // Botón para crear un nuevo servidor
        document.getElementById("createServerBtn").addEventListener("click", createNewServer);
    } else {
        window.location.href = "index.html";
    }
});

function showServerSelectScreen() {
    document.getElementById("serverSelect").style.display = "block";
}

function hideServerSelectScreen() {
    document.getElementById("serverSelect").style.display = "none";
}

function displayServers(servers) {
    const serverListDiv = document.getElementById("serverList");
    serverListDiv.innerHTML = ""; // Limpiar la lista antes de agregar los servidores

    for (const serverId in servers) {
        const server = servers[serverId];
        const serverButton = document.createElement("button");
        serverButton.textContent = `Servidor: ${server.name}`;
        serverButton.addEventListener("click", () => joinServer(serverId));
        serverListDiv.appendChild(serverButton);
    }
}

function joinServer(id) {
    serverId = id;
    db.ref(`servers/${serverId}/players`).push(player);
    hideServerSelectScreen();

    // Actualizar los datos del jugador
    db.ref(`players/${player.id}`).set(player);

    // Comenzar el juego
    db.ref(`servers/${serverId}`).on("value", snapshot => {
        const data = snapshot.val();
        players = data.players || {};
        points = data.points || [];
        gameLoop();
    });
}

function createNewServer() {
    const serverName = prompt("Introduce el nombre de tu nuevo servidor:");
    if (serverName) {
        const newServer = {
            name: serverName,
            players: {},
            points: generateInitialPoints()
        };

        const newServerRef = db.ref("servers").push();
        newServerRef.set(newServer).then(() => {
            serverId = newServerRef.key;
            joinServer(serverId);
        });
    }
}

function generateInitialPoints() {
    const points = [];
    for (let i = 0; i < 100; i++) {
        points.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 5 });
    }
    return points;
}

function generatePoints() {
    points = [];
    for (let i = 0; i < 100; i++) {
        points.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 5 });
    }
    db.ref("points").set(points);
}

function spawnPoints() {
    for (let i = 0; i < 20; i++) {
        points.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 5 });
    }
    db.ref("points").set(points);
}

function checkEmptyServer() {
    db.ref("players").once("value", snapshot => {
        if (!snapshot.exists()) generatePoints();
    });
}

function updateLeaderboard() {
    const leaderboard = document.getElementById("leaderboard");
    leaderboard.innerHTML = "<b>Leaderboard</b><br>";
    const sorted = Object.values(players).sort((a, b) => b.score - a.score);
    sorted.forEach(p => {
        leaderboard.innerHTML += `${p.name}: ${p.score} puntos<br>`;
    });
}

function checkCollisions() {
    points = points.filter(p => {
        const dist = Math.hypot(player.x - p.x, player.y - p.y);
        if (dist < player.size) {
            if (player.score < 300) {
                player.size = Math.min(player.size + 0.1, 100);
                player.score += 0.1;
            }
            if (player.score >= 470) {
                  db.ref(`players/${player.id}`).remove().then(() => {
                  window.location.href = "ganaste.html";
               });
            }
            return false;
        }
        return true;
    });

    for (const id in players) {
        if (id !== player.id) {
            const p = players[id];
            const dist = Math.hypot(player.x - p.x, player.y - p.y);
            if (dist < player.size && player.size > p.size) {
                player.size += p.size / 10;
                player.score += p.score;
                db.ref(`players/${id}`).remove();
            } else if (dist < p.size && p.size > player.size) {
                if (!hasLost) {
                    hasLost = true;
                    setTimeout(() => hasLost = false, 5000);
                    db.ref(`players/${player.id}`).remove().then(() => {
                        window.location.href = "perdiste.html";
                    });
                }
            }
        }
    }
    db.ref("points").set(points);
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    player.x += (targetX - player.x) * 0.02;
    player.y += (targetY - player.y) * 0.02;

    points.forEach(p => {
        ctx.font = "20px Arial"; // Cambia '20px' por el tamaño que prefieras
        ctx.fillStyle = "green";
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
    });

    for (const id in players) {
        const p = players[id];
        const img = new Image();
        img.src = p.image;

        ctx.save();
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.clip();
        ctx.drawImage(img, p.x - p.size, p.y - p.size, p.size * 2, p.size * 2);
        ctx.restore();
        ctx.fillStyle = "black";
        ctx.fillText(p.name, p.x - 20, p.y - p.size - 10);
    }

    checkCollisions();
    db.ref(`players/${player.id}`).set(player);
    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
