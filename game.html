<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Countryballs.io</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        #leaderboard {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
        }
        #countrySelect {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            color: white;
            display: none;
        }
    </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="leaderboard"></div>
<div id="countrySelect">
    <h2>Selecciona tu país</h2>
    <select id="countryDropdown"></select>
    <button onclick="selectCountry()">Jugar</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAZM_UTKUtkjoXSmhAU2yFaWTgt9oUwktA",
    authDomain: "virtualblocks-servers.firebaseapp.com",
    databaseURL: "https://virtualblocks-servers-default-rtdb.firebaseio.com",
    projectId: "virtualblocks-servers"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let player = { id: null, x: 0, y: 0, size: 30, country: "", name: "", score: 0 };
let players = {};
let points = [];
let targetX = 0, targetY = 0, hasLost = false;

auth.onAuthStateChanged(user => {
    if (user) {
        player.id = user.uid;
        player.name = user.displayName || "Anónimo";
        showCountrySelection();
    } else {
        auth.signInAnonymously();
    }
});

function showCountrySelection() {
    const select = document.getElementById("countryDropdown");
    select.innerHTML = "";
    db.ref("countriesAvailable").once("value", snapshot => {
        const countries = snapshot.val();
        if (countries) {
            for (let country in countries) {
                if (countries[country]) {
                    const option = document.createElement("option");
                    option.value = country;
                    option.textContent = country;
                    select.appendChild(option);
                }
            }
        }
        document.getElementById("countrySelect").style.display = "block";
    });
}

function selectCountry() {
    const selectedCountry = document.getElementById("countryDropdown").value;
    if (!selectedCountry) {
        alert("Selecciona un país");
        return;
    }

    player.country = selectedCountry;
    player.x = Math.random() * canvas.width;
    player.y = Math.random() * canvas.height;
    targetX = player.x;
    targetY = player.y;

    db.ref(`countriesAvailable/${selectedCountry}`).set(false);
    db.ref(`players/${player.id}`).set({
        id: player.id,
        x: player.x,
        y: player.y,
        size: player.size,
        country: player.country,
        name: player.name,
        score: player.score
    });

    document.getElementById("countrySelect").style.display = "none";

    window.addEventListener("mousemove", e => {
        targetX = e.clientX;
        targetY = e.clientY;
    });

    window.addEventListener("beforeunload", () => {
        db.ref(`players/${player.id}`).remove();
        db.ref(`countriesAvailable/${selectedCountry}`).set(true);
    });

    db.ref(`players/${player.id}`).onDisconnect().remove().then(() => {
        db.ref(`countriesAvailable/${selectedCountry}`).set(true);
    });

    spawnPoints();
    gameLoop();
}

function spawnPoints() {
    db.ref("points").once("value", snapshot => {
        if (!snapshot.exists()) {
            for (let i = 0; i < 100; i++) {
                points.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 5 });
            }
            db.ref("points").set(points);
        } else {
            points = snapshot.val();
        }
    });
}

function checkCollisions() {
    points = points.filter(p => {
        const dist = Math.hypot(player.x - p.x, player.y - p.y);
        if (dist < player.size) {
            player.size += 1;
            player.score += 1;
            return false;
        }
        return true;
    });

    db.ref("points").set(points);
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    player.x += (targetX - player.x) * 0.02;
    player.y += (targetY - player.y) * 0.02;

    points.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fillStyle = "green";
        ctx.fill();
    });

    for (const id in players) {
        const p = players[id];
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fillStyle = id === player.id ? "blue" : "red";
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = "white";
        ctx.font = "16px Arial";
        ctx.fillText(`${p.name} [${p.country}]`, p.x - 20, p.y - p.size - 10);
    }

    checkCollisions();
    db.ref(`players/${player.id}`).set(player);
    requestAnimationFrame(gameLoop);
}

function updateLeaderboard() {
    const leaderboard = document.getElementById("leaderboard");
    db.ref("players").once("value", snapshot => {
        const allPlayers = [];
        snapshot.forEach(child => {
            allPlayers.push(child.val());
        });

        allPlayers.sort((a, b) => b.score - a.score);
        leaderboard.innerHTML = "<h3>Leaderboard</h3>";
        allPlayers.forEach(p => {
            leaderboard.innerHTML += `${p.name} [${p.country}]: ${p.score}<br>`;
        });
    });
}

setInterval(updateLeaderboard, 1000);

window.addEventListener("resize", () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});
</script>
</body>
</html>
